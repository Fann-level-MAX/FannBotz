
import { createHash } from 'crypto'
import fetch from 'node-fetch'
import jimp from 'jimp'
import fs from 'fs'
import PhoneNumber from 'awesome-phonenumber'
let Reg = /\|?(.*)([.|] *?)([0-9]*)$/i

let handler = async function (m, { text, usedPrefix, command }) {
function pickRandom(list) {
  return list[Math.floor(Math.random() * list.length)]
}
let namae = conn.getName(m.sender)
const sections = [
{
title: "Select Your Age Here !",
rows: [
{title: "Random Years", rowId: '.daftar ' + namae + '.' + pickRandom(['30','29','28','27','26','25','24','23','22','21','20','19','18','17','16','15','14','13','12','11','10','9'])}
]},{
title: "O L D",
rows: [
{title: "60 Years", rowId: '.daftar ' + namae + '.60 '},
{title: "30 Years", rowId: '.daftar ' + namae + '.30 '},
{title: "29 Years", rowId: '.daftar ' + namae + '.29 '},
{title: "28 Years", rowId: '.daftar ' + namae + '.28 '},
{title: "27 Years", rowId: '.daftar ' + namae + '.27 '},
{title: "26 Years", rowId: '.daftar ' + namae + '.26 '},
{title: "25 Years", rowId: '.daftar ' + namae + '.25 '},
{title: "24 Years", rowId: '.daftar ' + namae + '.24 '},
{title: "23 Years", rowId: '.daftar ' + namae + '.23 '},
{title: "22 Years", rowId: '.daftar ' + namae + '.22 '},
{title: "21 Years", rowId: '.daftar ' + namae + '.21 '}
]
},
{
title: "Y O U N G",
rows: [
{title: "20 Years", rowId: '.daftar ' + namae + '.20 '},
{title: "19 Years", rowId: '.daftar ' + namae + '.19 '},
{title: "18 Years", rowId: '.daftar ' + namae + '.18 '},
{title: "17 Years", rowId: '.daftar ' + namae + '.17 '},
{title: "16 Years", rowId: '.daftar ' + namae + '.16 '},
{title: "15 Years", rowId: '.daftar ' + namae + '.15 '},
{title: "14 Years", rowId: '.daftar ' + namae + '.14 '},
{title: "13 Years", rowId: '.daftar ' + namae + '.13 '},
{title: "12 Years", rowId: '.daftar ' + namae + '.12 '},
{title: "11 Years", rowId: '.daftar ' + namae + '.11 '},
{title: "10 Years", rowId: '.daftar ' + namae + '.10 '},
{title: "9 Years", rowId: '.daftar ' + namae + '.9 '},
{title: "8 Years", rowId: '.daftar ' + namae + '.8 '},
{title: "7 Years", rowId: '.daftar ' + namae + '.7 '},
]},{
title: "B A Y I",
rows: [
{title: "6 Years", rowId: '.daftar ' + namae + '.6 '},
{title: "5 Years", rowId: '.daftar ' + namae + '.5 '},
{title: "4 Years", rowId: '.daftar ' + namae + '.4 '}
]},]

const listMessage = {
  text: `‚îÇ‚Ä∫Please select your age at the bottom button...`,
  footer: `‚îó * è·¥è·¥ú Ä …¥·¥Ä·¥ç·¥á:* ${namae}\n\n<‚ùî> Want a costume name?\nType : *${usedPrefix + command} yourname.age*\nExample : *${usedPrefix + command} ${namae}.15*`,
  title: "‚ñ¢- - - - -  Ä·¥á…¢…™s·¥õ·¥á Ä - - - - -",
  buttonText: "Click Here !",
  sections
}
  let user = global.db.data.users[m.sender]
  if (user.registered === true) throw `Anda sudah terdaftar\nMau daftar ulang? ${usedPrefix}unreg <SN|SERIAL NUMBER>`
  if (!Reg.test(text)) return conn.sendMessage(m.chat, listMessage, { quoted: m })
  //if (!Reg.test(text)) throw `Format salah\n*${usedPrefix}daftar nama.umur*`
  let [_, name, splitter, age] = text.match(Reg)
  if (!name) throw 'Nama tidak boleh kosong (Alphanumeric)'
  if (!age) throw 'Umur tidak boleh kosong (Angka)'
  age = parseInt(age)
  if (age > 50) throw '…™…¥…¢·¥Ä·¥õ ·¥ú·¥ç·¥ú Ä  è·¥Ä ·¥ã·¥Ä·¥ã·¥á·¥ã'
  if (age < 6) throw ' ô·¥Ä è…™ ·¥ç·¥Ä…¥·¥Ä  è…¢  ô…™s·¥Ä ·¥ç·¥Ä…™…¥ ·¥°·¥Ä'
  user.name = name.trim()
  user.age = age
  user.regTime = + new Date
  user.registered = true
  let sn = createHash('md5').update(m.sender).digest('hex')
  let tap = `

‚îè‚îÄ‚Ä¢ *·¥ús·¥á Äs*
‚îÇ‚ñ∏ *s·¥õ·¥Ä·¥õ·¥ús:* ‚òëÔ∏è s·¥ú·¥Ñ·¥Ñ·¥áss“ì·¥ú ü
‚îÇ‚ñ∏ *…¥·¥Ä·¥ç·¥á:* ${name}
‚îÇ‚ñ∏ *·¥Ä…¢·¥á:* ${age}  è·¥á·¥Ä Äs
‚îÇ‚ñ∏ *s…¥:* ${sn}
‚îó‚îÄ‚îÄ‚îÄ‚îÄ¬∑¬∑¬∑

·¥Ö·¥Ä·¥õ·¥Ä ·¥ús·¥á Ä  è·¥Ä…¥…¢ ·¥õ·¥á Äs…™·¥ç·¥ò·¥Ä…¥ ·¥Ö…™·¥Ö·¥Ä·¥õ·¥Ä ô·¥Äs·¥á  ô·¥è·¥õ, ·¥Ö…™·¥ä·¥Ä·¥ç…™…¥ ·¥Ä·¥ç·¥Ä…¥ ·¥õ·¥Ä…¥·¥ò·¥Ä ·¥õ·¥á Äs ú·¥Ä Ä·¥á üòâ
`
await conn.sendButtonImg(m.chat, await genProfile(conn, m), tap, '‚åï ‚ùô‚ùò‚ùô‚ùô‚ùò‚ùô‚ùö‚ùô‚ùò‚ùô‚ùô‚ùö‚ùô‚ùò‚ùô‚ùò‚ùô‚ùö‚ùô‚ùò‚ùô‚ùô‚ùö‚ùô‚ùò‚ùô‚ùô‚ùò‚ùô‚ùö‚ùô‚ùò ‚åï\n', 'menu', '.menu', m, { contextInfo: { externalAdReply: { showAdAttribution: true,
    mediaUrl: '',
    mediaType: 2, 
    description: sgc,
    title: "FannBotz",
    body: `${pickRandom(global.kata2)}`,
    thumbnail: fs.readFileSync('./media/thumb.jpg'),
    sourceUrl: sgc
     }}
  })
}
handler.help = ['daftar', 'reg', 'register'].map(v => v + ' <nama>.<umur>')
handler.tags = ['exp']

handler.command = /^(daftar|verify|reg(ister)?)$/i

async function genProfile(conn, m) {
  let font = await jimp.loadFont('./media/names.fnt'),
    mask = await jimp.read('https://i.imgur.com/552kzaW.png'),
    welcome = await jimp.read(thumbnailUrl.getRandom()),
    avatar = await jimp.read(await conn.profilePictureUrl(m.sender, 'image').catch(() => 'https://telegra.ph/file/24fa902ead26340f3df2c.png')),
    status = (await conn.fetchStatus(m.sender).catch(console.log) || {}).status?.slice(0, 30) || 'Not Detected'

    await avatar.resize(460, 460)
    await mask.resize(460, 460)
    await avatar.mask(mask)
    await welcome.resize(welcome.getWidth(), welcome.getHeight())

    await welcome.print(font, 550, 180, 'Name:')
    await welcome.print(font, 650, 255, m.pushName.slice(0, 25))
    await welcome.print(font, 550, 340, 'About:')
    await welcome.print(font, 650, 415, status)
    await welcome.print(font, 550, 500, 'Number:')
    await welcome.print(font, 650, 575, PhoneNumber('+' + m.sender.split('@')[0]).getNumber('international'))
    return await welcome.composite(avatar, 50, 170).getBufferAsync('image/png')
}

export default handler

